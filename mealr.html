# Mealr v16: Full build (Distance + Places + bugfixes) + Modal z-index + Instant language switch
html = r"""<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum=1, user-scalable=no" />
<title>Mealr v16 (Full)</title>
<style>
  :root {
    --bg:#1b0f0a; --fg:#fff6f0; --muted:#ffddc9;
    --primary:#ff8a3d; --primary-2:#ff5a5f;
    --card:#2b1912; --btn:#3a2219; --chip:#41251a;
    --disabled:#3a2a24; --disabled-text:#c8a99a;
    --select-bg:#2b1c14; --select-text:#f5e0c5; --select-border:#5a4638;
    --like:#6ee7a8; --nope:#fca5a5;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: rgba(0,0,0,0);}
  html,body{height:100%; margin:0; background:#000;}
  .phone { width: 390px; height: 100vh; max-height: 844px; margin: 0 auto;
    background: radial-gradient(900px 600px at 15% -10%, #3a2118, #1b0f0a), linear-gradient(180deg, #2a1710, #1b0f0a);
    color: var(--fg); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial;
    display:flex; flex-direction:column; overflow:hidden; border-left:1px solid rgba(255,255,255,.06); border-right:1px solid rgba(255,255,255,.06);}
  header{flex:0 0 auto; display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px;
    background:linear-gradient(180deg, rgba(27,15,10,.95), rgba(27,15,10,.75)); position:sticky; top:0; z-index:10; backdrop-filter: blur(6px);}
  header h1{margin:0; font-size:clamp(16px, 2.8vw, 18px); display:flex; align-items:center; gap:8px;}
  .dot{width:8px;height:8px;border-radius:50%;background:var(--primary);box-shadow:0 0 12px var(--primary-2),0 0 24px rgba(255,90,95,.4);display:inline-block;}
  .right{display:flex; align-items:center; gap:6px;}
  .iconbtn{border:1px solid rgba(255,255,255,.22); background:#3a2219; color:#ffe7d6; padding:8px 10px; border-radius:10px; cursor:pointer;}
  main{flex:1 1 auto; display:flex; flex-direction:column; overflow:hidden;}
  .stack{position:relative; flex:1 1 auto; margin:12px; border-radius:16px;}
  .swipe-card{position:absolute; inset:0; background:var(--card); border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:16px;
    box-shadow:0 14px 40px rgba(0,0,0,.55); display:flex; flex-direction:column; gap:8px; touch-action:none;
    transition: transform .25s ease, opacity .25s ease; z-index: 100; } /* keep under modals */
  .title{font-size:clamp(18px, 3.5vw, 22px); font-weight:800;}
  .meta{color:var(--muted); font-size:clamp(12px, 2.6vw, 13px); display:flex; gap:10px; align-items:center;}
  .price{font-weight:800; color:#ffd29b;}
  .row{display:flex; gap:8px; flex-wrap:wrap;}
  .chip{font-size:12px; color:#ffd9c6; background:#3a2118; padding:6px 9px; border-radius:999px; border:1px solid rgba(255,255,255,.14);}
  .controls{display:flex; gap:10px; padding:0 12px 12px;}
  .btn{flex:1; cursor:pointer; background:var(--btn); border:1px solid rgba(255,255,255,.18); padding:clamp(10px,3.4vw,14px) 14px; border-radius:14px; color:var(--fg); font-weight:700;}
  .btn.primary{background:linear-gradient(180deg,var(--primary),var(--primary-2)); color:#ffe7d6; border:none; box-shadow:0 6px 20px rgba(255,90,95,.18);}
  .hint{color:var(--muted); font-size:12px; text-align:center; padding:4px 0 10px;}
  .empty{color:var(--muted); text-align:center; margin-top:60px; padding:0 16px;}

  .badge{position:absolute; top:14px; padding:6px 10px; border:3px solid; border-radius:10px; font-weight:900; letter-spacing:.08em;
    transform:rotate(-15deg); opacity:0; transition:opacity .15s;}
  .badge.like{left:14px; color:#063; border-color:var(--like); background:rgba(110,231,168,.12);}
  .badge.nope{right:14px; color:#6b0000; border-color:var(--nope); background:rgba(252,165,165,.12); transform:rotate(15deg);}

  .overlay{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; z-index:2000; opacity:0; transition:opacity .25s ease;} /* high */
  .overlay.active{display:block; opacity:1;}
  .modal{position:fixed; left:50%; transform:translate(-50%, 20px); top:60px; width:360px; max-width:94vw;
    background:linear-gradient(180deg,#341e15,#24130d); border:1px solid rgba(255,255,255,.14); border-radius:16px; padding:14px; z-index:2001; display:none;
    opacity:0; transition: transform .25s ease, opacity .25s ease; color: var(--fg);} /* high */
  .modal.active{display:block; opacity:1; transform:translate(-50%, 0);}
  .label{font-size:12px; color:var(--muted); margin:8px 0 6px; text-transform:uppercase; letter-spacing:.08em;}
  .pill{background:var(--chip); border:1px solid rgba(255,255,255,.18); border-radius:999px; padding:8px 12px; color:var(--fg); font-size:14px; cursor:pointer;}
  input[type=range]{width:100%; accent-color:var(--primary-2);}

  .select{width:100%; background: var(--select-bg); color: var(--select-text); border: 1px solid var(--select-border);
    padding: 10px 12px; border-radius: 12px; font-size: 15px; appearance: none; outline: none;}
  .select option{background: var(--select-bg); color: var(--select-text);}

  .toggle{display:flex; align-items:center; justify-content:space-between; gap:10px; cursor:pointer; padding:10px 12px; border-radius:12px;
    background:rgba(255,255,255,.06); color:var(--muted); border:1px solid rgba(255,255,255,.18);}
  .toggle strong{color:var(--muted); font-weight:800;}
  .toggle input{appearance:none; width:46px; height:26px; border-radius:999px; background:#4a2a1e; position:relative; outline:none; border:1px solid rgba(255,255,255,.22); transition:background .2s;}
  .toggle input:checked{background:#ff8a3d;}
  .toggle input:before{content:""; position:absolute; top:2px; left:2px; width:20px; height:20px; background:#ffe7d6; border-radius:50%; transition:left .18s;}
  .toggle input:checked:before{left:24px;}

  .disabled{opacity:.5; pointer-events:none;}
  .disabled .pill{background:var(--disabled); color:var(--disabled-text); border-color:rgba(255,255,255,.12);}
  .disabled input[type=range]{opacity:.6;}

  #result{display:none; flex:1 1 auto; padding:12px; overflow:auto;}
  .card{background:var(--card); border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:16px; box-shadow:0 14px 40px rgba(0,0,0,.55);
    animation: fadeIn .25s ease;}
  .hero{width:100%; height:170px; border-radius:12px; object-fit:cover; margin-bottom:10px; border:1px solid rgba(255,255,255,.12); display:none;}
  .kv{margin-top:8px; color:#ffe7d6; font-size:14px;}
  .kv small{color:var(--muted); font-size:12px; display:block; margin-top:2px;}
  .result-controls{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;}
  .result-actions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;}
  .list-item{display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px dashed rgba(255,255,255,.12); color:var(--fg);}
  .list-meta{font-size:12px; color:var(--muted);}

  .action-btn{flex:1; display:inline-flex; align-items:center; justify-content:center; gap:8px;
    background:var(--btn); border:1px solid rgba(255,255,255,.18); color:var(--fg); padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; text-decoration:none;}
  .action-btn.primary{background:linear-gradient(180deg,var(--primary),var(--primary-2)); color:#220b07; border:none; box-shadow:0 6px 20px rgba(255,90,95,.18);}
  .action-icon{font-size:16px;}
</style>
</head>
<body>
  <div class="phone">
    <header>
      <h1><span class="dot"></span> Mealr</h1>
      <div class="right">
        <button id="btnHistory" class="iconbtn" title="History">ğŸ•˜</button>
        <button id="btnFavs" class="iconbtn" title="Favorites">â¤ï¸</button>
        <button id="btnSettings" class="iconbtn" aria-label="Settings">âš™ï¸</button>
      </div>
    </header>

    <main id="swipe">
      <div id="stack" class="stack"></div>
      <div class="controls">
        <button id="btnSkip" class="btn">ç•¥é</button>
        <button id="btnChoose" class="btn primary">é¸é€™å®¶</button>
      </div>
      <div id="hintKeys" class="hint">æç¤ºï¼šå¯ä»¥å·¦å³æ»‘å‹•å¡ç‰‡ï¼›ä¹Ÿå¯ç”¨æŒ‰éˆ•æ“ä½œã€‚</div>
    </main>

    <section id="result">
      <div id="resultCard" class="card">
        <img id="hero" class="hero" alt="photo"/>
        <div id="resultBody"></div>
        <div id="gEnrich" class="kv"></div>
      </div>
      <div class="result-controls">
        <button id="btnBack" class="btn">è¿”å›</button>
        <button id="btnFav" class="btn primary">æ”¶è—</button>
      </div>
      <div class="result-actions">
        <button id="btnMap" class="action-btn"><span class="action-icon">ğŸ“</span>é–‹åœ°åœ–</button>
        <button id="btnCall" class="action-btn"><span class="action-icon">ğŸ“</span>æ‰“é›»è©±</button>
        <a id="btnWebsite" class="action-btn" target="_blank" rel="noopener"><span class="action-icon">ğŸŒ</span>å®˜ç¶²</a>
      </div>
    </section>
  </div>

  <!-- è¨­å®š -->
  <div id="overlay" class="overlay"></div>
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
      <div class="label" id="mTitle">è¨­å®š</div>
      <button id="btnClose" class="iconbtn">âœ•</button>
    </div>
    <label class="toggle" style="margin-top:2px;">
      <strong id="lblBlind">ç›²é¸æ¨¡å¼ï¼ˆéš±è—åç¨±èˆ‡ç…§ç‰‡ï¼Œé¿å…åè¦‹ï¼‰</strong>
      <input id="blind" type="checkbox" />
    </label>
    <div id="filtersBlock" style="margin-top:10px;">
      <div class="label" id="lblBudget">é ç®—ï¼ˆTWDï¼‰</div>
      <div class="row"><span id="budgetShow" class="pill">â‰¤ 300</span></div>
      <input id="budget" type="range" min="120" max="1000" step="10" value="300" />
      <div class="hint" id="hintBudget">æ‹–æ›³è¨­å®šä½ çš„æœ€é«˜èŠ±è²»ã€‚</div>

      <div class="label" id="lblDistance">è·é›¢ï¼ˆå…¬é‡Œï¼‰</div>
      <div class="row"><span id="distanceShow" class="pill">â‰¤ 2.0 km</span></div>
      <input id="distance" type="range" min="200" max="2000" step="100" value="2000" />
      <div class="hint" id="hintDistance">éœ€å…è¨±å®šä½èˆ‡åº—å®¶æœ‰åº§æ¨™ï¼›å¦å‰‡ä¸æœƒå¥—ç”¨ã€‚</div>

      <div class="label" id="lblVibe">æ°›åœ</div>
      <div class="row" id="vibeRow">
        <button class="pill" data-vibe="quiet">å®‰éœ</button>
        <button class="pill" data-vibe="casual">è¼•é¬†</button>
        <button class="pill" data-vibe="fast">å¿«é€Ÿ</button>
        <button class="pill" data-vibe="group">é©åˆå¤šäºº</button>
      </div>

      <div class="label" id="lblCuisine">æ–™ç†é¡å‹</div>
      <div class="row" id="cuisineRow">
        <button class="pill" data-cuisine="sushi">å£½å¸</button>
        <button class="pill" data-cuisine="bento">ä¾¿ç•¶</button>
        <button class="pill" data-cuisine="noodles">éºµé£Ÿ</button>
        <button class="pill" data-cuisine="thai">æ³°å¼</button>
        <button class="pill" data-cuisine="rice">ä¸¼é£¯/è“‹é£¯</button>
        <button class="pill" data-cuisine="vegan">è”¬é£Ÿ</button>
      </div>
    </div>
    <div class="label" id="lblLang" style="margin-top:12px;">èªè¨€</div>
    <select id="langSelModal" class="select">
      <option value="zh">ç¹é«”ä¸­æ–‡</option>
      <option value="en">English</option>
    </select>
    <div style="display:flex; gap:10px; margin-top:12px; justify-content:flex-end;">
      <button id="applySettings" class="btn primary" style="width:auto;">å¥—ç”¨</button>
    </div>
  </div>

  <!-- æ”¶è— -->
  <div id="favOverlay" class="overlay"></div>
  <div id="favModal" class="modal" role="dialog" aria-modal="true">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div class="label" id="favTitle">æ”¶è—æ¸…å–®</div>
      <button id="favClose" class="iconbtn">âœ•</button>
    </div>
    <div id="favList" style="margin-top:6px;"></div>
  </div>

  <!-- æ­·å² -->
  <div id="histOverlay" class="overlay"></div>
  <div id="histModal" class="modal" role="dialog" aria-modal="true">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div class="label" id="histTitle">æ­·å²ç´€éŒ„</div>
      <button id="histClose" class="iconbtn">âœ•</button>
    </div>
    <div id="histList" style="margin-top:6px;"></div>
  </div>

<script>
// ====== CONFIG ======
const GOOGLE_API_KEY = ""; // set to enable Places
const USE_PLACES = !!GOOGLE_API_KEY;

// ====== I18N ======
const I18N = {
  zh: {settings:"è¨­å®š", language:"èªè¨€", skip:"ç•¥é", choose:"é¸é€™å®¶", back:"è¿”å›", shuffle:"é‡æ–°æ´—ç‰Œ",
       hintKeys:"æç¤ºï¼šå¯ä»¥å·¦å³æ»‘å‹•å¡ç‰‡ï¼›ä¹Ÿå¯ç”¨æŒ‰éˆ•æ“ä½œã€‚", budget:"é ç®—ï¼ˆTWDï¼‰", vibe:"æ°›åœ", cuisines:"æ–™ç†é¡å‹",
       blind:"ç›²é¸æ¨¡å¼ï¼ˆéš±è—åç¨±èˆ‡ç…§ç‰‡ï¼Œé¿å…åè¦‹ï¼‰", noMatches:"æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„åº—å®¶ï¼Œè©¦è‘—æ”¾å¯¬æ¢ä»¶ã€‚",
       todaysPick:"ä»Šæ—¥æ¨è–¦", hours:"ç‡Ÿæ¥­æ™‚é–“", yourPick:"ä½ çš„é¸æ“‡", distance:"è·é›¢", favorites:"æ”¶è—æ¸…å–®", fav:"æ”¶è—",
       history:"æ­·å²ç´€éŒ„", remove:"ç§»é™¤", emptyFav:"å°šæœªæ”¶è—", emptyHist:"å°šç„¡ç´€éŒ„", like:"é¸é€™å®¶", nope:"ç•¥é",
       openMap:"é–‹åœ°åœ–", call:"æ‰“é›»è©±", address:"åœ°å€", phone:"é›»è©±", website:"å®˜ç¶²", nowOpen:"ç‡Ÿæ¥­ä¸­", nowClose:"ä¼‘æ¯ä¸­",
       reviews:"å‰‡è©•åƒ¹", price:"åƒ¹æ ¼",
       vibeText:{quiet:"å®‰éœ", casual:"è¼•é¬†", fast:"å¿«é€Ÿ", group:"é©åˆå¤šäºº"},
       cuText:{sushi:"å£½å¸", bento:"ä¾¿ç•¶", noodles:"éºµé£Ÿ", thai:"æ³°å¼", rice:"ä¸¼é£¯/è“‹é£¯", vegan:"è”¬é£Ÿ"}
  },
  en: {settings:"Settings", language:"Language", skip:"Skip", choose:"Choose", back:"Back", shuffle:"Shuffle",
       hintKeys:"Tip: swipe left/right; or use buttons.", budget:"Budget (TWD)", vibe:"Vibe", cuisines:"Cuisines",
       blind:"Blind Mode (hide names/photos)", noMatches:"No matches. Try widening filters.",
       todaysPick:"Today's Pick", hours:"Hours", yourPick:"Your pick", distance:"Distance", favorites:"Favorites", fav:"Favorite",
       history:"History", remove:"Remove", emptyFav:"No favorites yet", emptyHist:"No history yet", like:"Choose", nope:"Skip",
       openMap:"Open Map", call:"Call", address:"Address", phone:"Phone", website:"Website", nowOpen:"Open now", nowClose:"Closed",
       reviews:"reviews", price:"Price",
       vibeText:{quiet:"Quiet", casual:"Casual", fast:"Fast", group:"Group-friendly"},
       cuText:{sushi:"Sushi", bento:"Bento", noodles:"Noodles", thai:"Thai", rice:"Rice Bowls", vegan:"Vegan"}
  }
};
let lang = localStorage.getItem("mealr_lang") || (navigator.language && navigator.language.startsWith("zh")? "zh":"en");

// ====== DATA ======
const RESTAURANTS = [
  { id:1, name_zh:"é®¨é’", name_en:"Ao Sushi", cuisine:["sushi"], vibe:["quiet","casual"], price:280, rating:4.5, time:"11:30â€“14:30", phone:"+886-2-2222-1111", address:"Taipei", place_id:"" , note:{en:"Counter seats, mini omakase", zh:"å§æª¯åº§ï¼Œè¿·ä½ ç„¡èœå–®"} },
  { id:2, name_zh:"æœ¨ç¦¾ä¾¿ç•¶", name_en:"Muhe Bento", cuisine:["bento","rice"], vibe:["fast","casual"], price:120, rating:4.2, time:"11:00â€“20:00", phone:"+886-2-2222-2222", address:"Taipei", place_id:"", note:{en:"Lean options", zh:"æ¸…çˆ½é¸é …"} },
  { id:3, name_zh:"å°å±±å£½å¸", name_en:"Koyama Sushi", cuisine:["sushi"], vibe:["quiet"], price:320, rating:4.3, time:"11:30â€“14:00", phone:"+886-2-3333-3333", address:"Taipei", place_id:"", note:{en:"Calm vibe, soft music", zh:"å®‰éœæ°›åœï¼Œè¼•éŸ³æ¨‚"} },
  { id:4, name_zh:"æ¸…æ¹¯æ‹‰éºµ", name_en:"Light Broth Ramen", cuisine:["noodles"], vibe:["fast"], price:180, rating:4.0, time:"11:00â€“21:00", phone:"+886-2-4444-4444", address:"Taipei", place_id:"", note:{en:"Light broth", zh:"æ¸…çˆ½æ¹¯é ­"} },
  { id:5, name_zh:"æ³°æ³°", name_en:"ThaiThai", cuisine:["thai"], vibe:["group","casual"], price:260, rating:4.4, time:"11:00â€“15:00", phone:"+886-2-5555-5555", address:"Taipei", place_id:"", note:{en:"Great for sharing", zh:"é©åˆåˆ†é£Ÿ"} },
  { id:6, name_zh:"ç±³é£Ÿå ‚", name_en:"Rice House", cuisine:["rice","vegan"], vibe:["quiet"], price:200, rating:4.1, time:"11:00â€“14:00", phone:"+886-2-6666-6666", address:"Taipei", place_id:"", note:{en:"Plant-forward bowls", zh:"æ¤ç‰©ç³»ç¢—é¤"} },
  { id:7, name_zh:"å•†åˆä¾¿ç•¶", name_en:"Office Lunch Bento", cuisine:["bento"], vibe:["fast","casual"], price:130, rating:3.9, time:"11:00â€“14:00", phone:"+886-2-7777-7777", address:"Taipei", place_id:"", note:{en:"Quick & cheap", zh:"å¿«é€Ÿå¯¦æƒ "} },
  { id:8, name_zh:"ç‚­çƒ¤ä¸¼", name_en:"Charcoal Don", cuisine:["rice"], vibe:["casual","group"], price:240, rating:4.2, time:"11:30â€“14:30", phone:"+886-2-8888-8888", address:"Taipei", place_id:"", note:{en:"Charcoal grill", zh:"ç‚­çƒ¤é¦™æ°£"} },
  { id:9, name_zh:"éœè¬å£½å¸", name_en:"Serene Sushi", cuisine:["sushi"], vibe:["quiet"], price:290, rating:4.6, time:"12:00â€“14:30", phone:"+886-2-9999-9999", address:"Taipei", place_id:"", note:{en:"Low-noise policy", zh:"ä½å™ªéŸ³è¦å‰‡"} },
  { id:10, name_zh:"è”¬é£Ÿéºµæ‰€", name_en:"Veggie Noodle", cuisine:["vegan","noodles"], vibe:["quiet","casual"], price:190, rating:4.0, time:"11:00â€“14:30", phone:"+886-2-1010-1010", address:"Taipei", place_id:"", note:{en:"No garlic/onion options", zh:"å¯é¸äº”è¾›ç´ "} }
];

// ====== STATE ======
let filters = JSON.parse(localStorage.getItem("mealr_filters") || '{"budget":300,"distance":2000,"vibes":[],"cuisines":[],"blind":false}');
if(filters.distance==null) filters.distance = 2000;
filters.vibes = new Set(filters.vibes); filters.cuisines = new Set(filters.cuisines);
let blindMode = !!filters.blind;
let pool = []; let index = 0; let current = null;
let favs = JSON.parse(localStorage.getItem("mealr_favs")||"[]");
let history = JSON.parse(localStorage.getItem("mealr_hist")||"[]");
let userPos = null;
const geoCache = {}; // id -> {lat,lng}

// ====== HELPERS ======
const $ = s => document.querySelector(s);
function t(k){ return I18N[lang][k]; }
function nameOf(r){ return lang==="zh" ? r.name_zh : r.name_en; }
function saveFilters(){ localStorage.setItem("mealr_filters", JSON.stringify({budget:filters.budget, distance:filters.distance, vibes:[...filters.vibes], cuisines:[...filters.cuisines], blind:blindMode})); }
function metersToText(m){ if(m<1000) return Math.round(m)+" m"; return (m/1000).toFixed(1)+" km"; }
function toRad(d){return d*Math.PI/180;}
function haversine(a,b,c,d){ const R=6371000; const dLat=toRad(c-a), dLon=toRad(d-b); const A=Math.sin(dLat/2)**2 + Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(Math.min(1,Math.max(-1,Math.sin(dLon/2)))**2); return 2*R*Math.asin(Math.sqrt(A)); }

function applyFiltersSync(){
  let arr = RESTAURANTS.filter(r => r.price <= (filters.budget || 300));
  if (filters.vibes.size) arr = arr.filter(r => [...filters.vibes].every(v => r.vibe.includes(v)));
  if (filters.cuisines.size) arr = arr.filter(r => r.cuisine.some(c => filters.cuisines.has(c)));
  return arr;
}

// ====== Google Places ======
async function fetchPlaceDetails(placeId){
  if(!USE_PLACES || !placeId) return null;
  const fields = [
    "name","rating","user_ratings_total","price_level","formatted_address","international_phone_number","website","url",
    "opening_hours","photos","geometry","delivery","dine_in","takeout","editorial_summary"
  ].join(",");
  const url = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${encodeURIComponent(placeId)}&fields=${encodeURIComponent(fields)}&language=${lang==="zh"?"zh-TW":"en"}&key=${GOOGLE_API_KEY}`;
  const res = await fetch(url); if(!res.ok) return null;
  const data = await res.json(); if(data.status!=="OK") return null;
  return data.result;
}
function photoUrl(ref, max=900){
  return `https://maps.googleapis.com/maps/api/place/photo?maxwidth=${max}&photo_reference=${encodeURIComponent(ref)}&key=${GOOGLE_API_KEY}`;
}
async function fetchGeometry(r){
  if(!USE_PLACES || !r.place_id || geoCache[r.id]) return;
  try{
    const url = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${encodeURIComponent(r.place_id)}&fields=geometry&key=${GOOGLE_API_KEY}`;
    const res = await fetch(url); if(!res.ok) return;
    const data = await res.json(); if(data.status!=="OK") return;
    const g = data.result.geometry && data.result.geometry.location;
    if(g) geoCache[r.id] = {lat:g.lat, lng:g.lng};
  }catch(e){}
}

// ====== UI TEXT ======
function updateFilterLabels(){
  $("#vibeRow").querySelectorAll("button").forEach(btn=>{
    const key = btn.getAttribute("data-vibe");
    btn.textContent = I18N[lang].vibeText[key];
  });
  $("#cuisineRow").querySelectorAll("button").forEach(btn=>{
    const key = btn.getAttribute("data-cuisine");
    btn.textContent = I18N[lang].cuText[key];
  });
}
function renderText(){
  $("#btnSkip").textContent=t("skip"); $("#btnChoose").textContent=t("choose"); $("#btnBack").textContent=t("back"); $("#btnFav").textContent=t("fav");
  $("#hintKeys").textContent=t("hintKeys"); $("#mTitle").textContent=t("settings"); $("#lblLang").textContent=t("language");
  $("#lblBudget").textContent=t("budget"); $("#lblVibe").textContent=t("vibe"); $("#lblCuisine").textContent=t("cuisines"); $("#lblBlind").textContent=t("blind");
  $("#favTitle").textContent=t("favorites"); $("#histTitle").textContent=t("history");
  $("#btnMap").innerHTML = `<span class="action-icon">ğŸ“</span>${t("openMap")}`;
  $("#btnCall").innerHTML = `<span class="action-icon">ğŸ“</span>${t("call")}`;
  $("#btnWebsite").innerHTML = `<span class="action-icon">ğŸŒ</span>${t("website")}`;
  $("#lblDistance").textContent = lang==="zh" ? "è·é›¢ï¼ˆå…¬é‡Œï¼‰" : "Distance (km)";
  $("#hintDistance").textContent = lang==="zh" ? "éœ€å…è¨±å®šä½èˆ‡åº—å®¶æœ‰åº§æ¨™ï¼›å¦å‰‡ä¸æœƒå¥—ç”¨ã€‚" : "Requires location + place coordinates.";
  $("#distanceShow").textContent = "â‰¤ " + (filters.distance/1000).toFixed(1) + " km";
  updateFilterLabels();
}

// ====== STACK ======
function renderStack(){
  const stack=$("#stack"); stack.innerHTML="";
  const topN = pool.slice(index, index+3);
  if(!topN.length){ stack.innerHTML = `<div class="empty">${t("noMatches")}</div>`; return; }
  const cuMap = I18N[lang].cuText;
  const vibeMap = I18N[lang].vibeText;

  for(let j = Math.min(2, topN.length-1); j>=0; j--){
    const r = topN[j];
    const depth = j;
    const card=document.createElement("div"); card.className="swipe-card";
    card.style.transform=`translateY(${depth*8}px) scale(${1-depth*0.02})`; card.style.opacity=1-depth*0.05;
    card.style.zIndex = String(100 - depth);

    const title = blindMode ? t("todaysPick") : nameOf(r);
    const meta = `${blindMode? "â€”" : "â˜… " + r.rating.toFixed(1)} â€¢ ${blindMode? "â€”" : r.cuisine.map(c=>cuMap[c]).join(", ")} â€¢ <span class="price">â‰ˆ ${r.price} TWD</span>`;
    const chips = r.vibe.map(v=>`<span class="chip">${vibeMap[v]}</span>`).join("");
    const note = blindMode ? (lang==="zh"?"ç›²é¸æ¨¡å¼ï¼šç´°ç¯€éš±è—":"Details hidden (Blind Mode)") : r.note[lang];
    const hours = blindMode ? "" : `${t("hours")}: ${r.time}`;
    card.innerHTML = `<div class="badge like" id="badgeLike">${t("like")}</div>
      <div class="badge nope" id="badgeNope">${t("nope")}</div>
      <div class="title">${title}</div>
      <div class="meta">${meta}</div>
      <div class="row">${chips}</div>
      <div style="color:#ffe7d6;">${note}</div>
      <div class="hint">${hours}</div>`;
    if(j===0) attachDrag(card);
    stack.appendChild(card);
  }
}
function show(screen){
  if(screen==="swipe"){ $("#swipe").style.display="flex"; $("#result").style.display="none"; renderStack(); }
  else { $("#swipe").style.display="none"; $("#result").style.display="block"; }
}

// ====== RESULT ======
function googleMapUrl(r, addr){
  const q = encodeURIComponent(`${nameOf(r)} ${addr || r.address || ""}`.trim());
  return `https://www.google.com/maps/search/?api=1&query=${q}`;
}
function appendKV(k, v){
  const el = document.createElement("div");
  el.className="kv";
  el.innerHTML = `<strong>${k}</strong><br><small>${v}</small>`;
  $("#gEnrich").appendChild(el);
}
function renderBaseResult(r){
  const cuMap = I18N[lang].cuText;
  const vibeMap = I18N[lang].vibeText;
  const rname = blindMode ? t("yourPick") : nameOf(r);
  const rating = blindMode ? "" : `â˜… ${r.rating.toFixed(1)} â€¢ `;
  const cuisine = r.cuisine.map(c=>cuMap[c]).join(", ");
  const price = `â‰ˆ ${r.price} TWD`;
  const note = blindMode ? (lang==="zh"?"ç›²é¸æ¨¡å¼ï¼šåˆ°åº—æ­æ›‰ï¼":"Blind Mode: reveal by visiting!") : r.note[lang];
  $("#hero").style.display="none"; $("#hero").src="";
  $("#resultBody").innerHTML = `<div class="title">${rname}</div>
    <div class="meta" style="margin:6px 0 10px;">${rating}${cuisine} â€¢ <span class="price">${price}</span></div>
    <div class="row">${r.vibe.map(v=>`<span class="chip">${vibeMap[v]}</span>`).join("")}</div>
    <div style="margin-top:10px; color:#ffe7d6;">${note}</div>`;
  $("#gEnrich").innerHTML = "";
}
async function enrichWithPlaces(r){
  if(!r.place_id || !USE_PLACES || blindMode) return;
  try{
    const detail = await fetchPlaceDetails(r.place_id);
    if(!detail) return;

    if(detail.photos && detail.photos.length){
      const ref = detail.photos[0].photo_reference;
      $("#hero").src = photoUrl(ref, 900);
      $("#hero").style.display = "block";
    }
    $("#btnMap").onclick = ()=> window.open(detail.url || googleMapUrl(r, detail.formatted_address), "_blank");
    const tel = detail.international_phone_number || detail.formatted_phone_number;
    if(tel) $("#btnCall").onclick = ()=> window.location.href = `tel:${tel.replace(/[^+\\d]/g,'')}`;
    $("#btnWebsite").style.display = detail.website ? "inline-flex" : "none";
    if(detail.website) $("#btnWebsite").href = detail.website;

    if(detail.geometry && detail.geometry.location){
      const lat = detail.geometry.location.lat; const lng = detail.geometry.location.lng;
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          userPos = {lat: pos.coords.latitude, lng: pos.coords.longitude};
          const dist = haversine(userPos.lat, userPos.lng, lat, lng);
          appendKV(`${t("distance")}`, metersToText(dist));
        }, ()=>{});
      }
    }

    if(detail.rating!=null){
      appendKV(`â˜… ${detail.rating.toFixed(1)}`, `${detail.user_ratings_total || 0} ${t("reviews")}${detail.price_level!=null? " Â· " + "$".repeat(detail.price_level):""}`);
    }
    if(detail.opening_hours){
      const openNow = detail.opening_hours.open_now;
      const weekday = detail.opening_hours.weekday_text;
      appendKV(`${t("hours")}`, `${openNow? t("nowOpen"): t("nowClose")}${weekday? `<br><small>${weekday[new Date().getDay()===0?6:new Date().getDay()-1] || ""}</small>`:""}`);
    }
    if(detail.formatted_address){ appendKV(`${t("address")}`, detail.formatted_address); }
    if(tel){ appendKV(`${t("phone")}`, tel); }
    const svc = ["dine_in","takeout","delivery"].filter(k=> detail[k]===true);
    if(svc.length){ appendKV("Service", svc.join(" Â· ")); }
    if(detail.editorial_summary && detail.editorial_summary.overview){
      appendKV("Info", detail.editorial_summary.overview);
    }
  }catch(e){ console.warn(e); }
}
function choose(r){
  current = r;
  history.unshift({id:r.id, ts: Date.now()}); history = history.slice(0, 50);
  localStorage.setItem("mealr_hist", JSON.stringify(history));

  renderBaseResult(r);
  enrichWithPlaces(r);

  $("#btnMap").onclick = ()=> window.open(googleMapUrl(r), "_blank");
  $("#btnCall").onclick = ()=>{
    const tel = r.phone ? `tel:${r.phone.replace(/[^+\\d]/g,'')}` : null;
    if(tel){ window.location.href = tel; }
    else { alert(lang==="zh" ? "æ²’æœ‰é›»è©±è³‡è¨Š" : "No phone available"); }
  };
  $("#btnWebsite").style.display="none";

  show("result");
}

function nextCard(liked){
  const r = pool[index];
  if(!r){ show("result"); return; }
  if(liked){ choose(r); return; }
  index++; if(index>=pool.length) index=0;
  renderStack();
}

// ====== GESTURE ======
let startX=0, currentX=0, dragging=false;
function attachDrag(card){
  const likeBadge = card.querySelector("#badgeLike");
  const nopeBadge = card.querySelector("#badgeNope");
  const threshold = 90;
  const onStart = (x)=>{ dragging=true; startX=x; card.style.transition="none"; likeBadge.style.opacity=0; nopeBadge.style.opacity=0; };
  const onMove = (x)=>{
    if(!dragging) return;
    currentX = x - startX;
    const rot = currentX/20; const prog = Math.min(1, Math.abs(currentX)/150);
    card.style.transform = `translate(${currentX}px,0) rotate(${rot}deg)`;
    card.style.opacity = String(Math.max(0.35, 1 - Math.abs(currentX)/320));
    if(currentX>0){ likeBadge.style.opacity = prog; nopeBadge.style.opacity = 0; } else { likeBadge.style.opacity = 0; nopeBadge.style.opacity = prog; }
  };
  const onEnd = ()=>{
    if(!dragging) return;
    dragging=false; card.style.transition="";
    if(Math.abs(currentX) > threshold){
      const liked = currentX>0;
      card.style.transform = `translate(${liked? 480:-480}px,0) rotate(${liked?15:-15}deg)`;
      setTimeout(()=> nextCard(liked), 140);
    }else{
      card.style.transform = ""; card.style.opacity = "1"; likeBadge.style.opacity=0; nopeBadge.style.opacity=0;
    }
    currentX=0;
  };
  card.ontouchstart = e=> onStart(e.touches[0].clientX);
  card.ontouchmove  = e=> onMove(e.touches[0].clientX);
  card.ontouchend   = onEnd;
  card.onmousedown = e=>{ onStart(e.clientX); };
  window.onmousemove = e=> onMove(e.clientX);
  window.onmouseup = onEnd;
}

// ====== FAV/HISTORY ======
function renderFavs(){
  const list = $("#favList"); list.innerHTML="";
  if(!favs.length){ list.innerHTML = `<div class="empty">${t("emptyFav")}</div>`; return; }
  favs.forEach(id=>{
    const r = RESTAURANTS.find(x=>x.id===id); if(!r) return;

    const row = document.createElement("div");
    row.className = "list-item";
    row.setAttribute("role", "button");
    row.tabIndex = 0;
    row.style.cursor = "pointer";

    const left = document.createElement("div");
    left.innerHTML = `${nameOf(r)} Â· <span class="price">â‰ˆ ${r.price} TWD</span>`;

    const btn = document.createElement("button");
    btn.className = "iconbtn";
    btn.textContent = t("remove");
    btn.setAttribute("data-id", String(id));

    const openDetail = ()=>{ choose(r); closeFav(); };
    row.onclick = openDetail;
    row.onkeydown = (e)=>{ if(e.key === "Enter" || e.key === " ") { e.preventDefault(); openDetail(); } };

    btn.onclick = (e)=>{
      e.stopPropagation();
      const rid = +e.currentTarget.getAttribute("data-id");
      favs = favs.filter(x=>x!==rid);
      localStorage.setItem("mealr_favs", JSON.stringify(favs));
      renderFavs();
    };

    row.appendChild(left);
    row.appendChild(btn);
    list.appendChild(row);
  });
}
function addFav(r){ if(!favs.includes(r.id)){ favs.unshift(r.id); localStorage.setItem("mealr_favs", JSON.stringify(favs)); } }

function renderHistory(){
  const list = $("#histList"); list.innerHTML="";
  if(!history.length){ list.innerHTML = `<div class="empty">${t("emptyHist")}</div>`; return; }
  history.forEach(item=>{
    const r = RESTAURANTS.find(x=>x.id===item.id); if(!r) return;

    const row = document.createElement("div");
    row.className="list-item";
    row.setAttribute("role","button");
    row.tabIndex = 0;
    row.style.cursor = "pointer";

    const timeStr = new Date(item.ts).toLocaleString(lang==="zh"?"zh-TW":"en-US");

    const left = document.createElement("div");
    left.innerHTML = `<div>${nameOf(r)} Â· <span class="price">â‰ˆ ${r.price} TWD</span></div><div class="list-meta">${timeStr}</div>`;

    const btn = document.createElement("button");
    btn.className = "iconbtn";
    btn.textContent = t("remove");
    btn.setAttribute("data-ts", String(item.ts));

    const openDetail = ()=>{ choose(r); closeHist(); };
    row.onclick = openDetail;
    row.onkeydown = (e)=>{ if(e.key==="Enter" || e.key===" "){ e.preventDefault(); openDetail(); } };

    btn.onclick = (e)=>{
      e.stopPropagation();
      const ts = +e.currentTarget.getAttribute("data-ts");
      history = history.filter(x=>x.ts!==ts);
      localStorage.setItem("mealr_hist", JSON.stringify(history));
      renderHistory();
    };

    row.appendChild(left);
    row.appendChild(btn);
    list.appendChild(row);
  });
}

// ====== SETTINGS ======
const overlay = $("#overlay"), modal = $("#modal");
function openModal(){ overlay.classList.add("active"); modal.classList.add("active"); syncUIFromState(); }
function closeModal(){ overlay.classList.remove("active"); modal.classList.remove("active"); }
$("#btnSettings").addEventListener("click", openModal);
$("#btnClose").addEventListener("click", closeModal);
overlay.addEventListener("click", closeModal);

function syncUIFromState(){
  $("#langSelModal").value = lang;
  $("#budget").value = filters.budget || 300;
  $("#budgetShow").textContent = "â‰¤ " + $("#budget").value;
  $("#distance").value = filters.distance || 2000;
  $("#distanceShow").textContent = "â‰¤ " + (filters.distance/1000).toFixed(1) + " km";
  $("#blind").checked = blindMode;
  updateFilterLabels();

  $("#vibeRow").querySelectorAll("button").forEach(b=>{ b.classList.remove("active"); b.style.background="var(--chip)"; b.style.color="var(--fg)"; });
  $("#cuisineRow").querySelectorAll("button").forEach(b=>{ b.classList.remove("active"); b.style.background="var(--chip)"; b.style.color="var(--fg)"; });
  filters.vibes.forEach(v=>{ const b=$("#vibeRow").querySelector(`[data-vibe="${v}"]`); if(b){ b.classList.add("active"); b.style.background="linear-gradient(180deg, var(--primary), var(--primary-2))"; b.style.color="#220b07"; }});
  filters.cuisines.forEach(c=>{ const b=$("#cuisineRow").querySelector(`[data-cuisine="${c}"]`); if(b){ b.classList.add("active"); b.style.background="#4a2a1e"; b.style.color="#ffd29b"; }});
  $("#filtersBlock").classList.toggle("disabled", blindMode);
}

$("#budget").addEventListener("input", e=> $("#budgetShow").textContent = "â‰¤ " + e.target.value );
$("#distance").addEventListener("input", e=>{
  filters.distance = +e.target.value;
  $("#distanceShow").textContent = "â‰¤ " + (filters.distance/1000).toFixed(1) + " km";
});
$("#vibeRow").addEventListener("click", e=>{
  const btn = e.target.closest("button[data-vibe]"); if(!btn || blindMode) return;
  const k = btn.dataset.vibe;
  if (filters.vibes.has(k)) { filters.vibes.delete(k); btn.style.background="var(--chip)"; btn.style.color="var(--fg)"; }
  else { filters.vibes.add(k); btn.style.background="linear-gradient(180deg, var(--primary), var(--primary-2))"; btn.style.color="#220b07"; }
});
$("#cuisineRow").addEventListener("click", e=>{
  const btn = e.target.closest("button[data-cuisine]"); if(!btn || blindMode) return;
  const k = btn.dataset.cuisine;
  if (filters.cuisines.has(k)) { filters.cuisines.delete(k); btn.style.background="var(--chip)"; btn.style.color="var(--fg)"; }
  else { filters.cuisines.add(k); btn.style.background="#4a2a1e"; btn.style.color="#ffd29b"; }
});
$("#blind").addEventListener("change", e=>{ blindMode = e.target.checked; $("#filtersBlock").classList.toggle("disabled", blindMode); });

// Apply settings
$("#applySettings").addEventListener("click", async ()=>{
  filters.budget = +$("#budget").value; 
  saveFilters(); 
  await refreshPool(); 
  if(current) choose(current); 
  closeModal();
});

// Instant language switch
const langSel = document.getElementById("langSelModal");
langSel.addEventListener("change", ()=>{
  lang = langSel.value;
  localStorage.setItem("mealr_lang", lang);
  renderText();
  renderStack();
  // refresh result card if open
  if(current){ renderBaseResult(current); enrichWithPlaces(current); }
  // also refresh list/popups if open
  if(document.getElementById("favModal").classList.contains("active")) renderFavs();
  if(document.getElementById("histModal").classList.contains("active")) renderHistory();
});

// ====== MODALS ======
const favOverlay=$("#favOverlay"), favModal=$("#favModal");
function openFav(){ favOverlay.classList.add("active"); favModal.classList.add("active"); renderFavs(); }
function closeFav(){ favOverlay.classList.remove("active"); favModal.classList.remove("active"); }
$("#btnFavs").addEventListener("click", openFav);
$("#favClose").addEventListener("click", closeFav);
favOverlay.addEventListener("click", closeFav);

const histOverlay=$("#histOverlay"), histModal=$("#histModal");
function openHist(){ histOverlay.classList.add("active"); histModal.classList.add("active"); renderHistory(); }
function closeHist(){ histOverlay.classList.remove("active"); histModal.classList.remove("active"); }
$("#btnHistory").addEventListener("click", openHist);
$("#histClose").addEventListener("click", closeHist);
histOverlay.addEventListener("click", closeHist);

// ====== MAIN BTN ======
$("#btnSkip").addEventListener("click", ()=> nextCard(false));
$("#btnChoose").addEventListener("click", ()=> nextCard(true));
$("#btnBack").addEventListener("click", ()=> show("swipe"));
$("#btnFav").addEventListener("click", ()=>{ if(current) addFav(current); openFav(); });

// ====== DISTANCE FILTER (build pool) ======
async function refreshPool(){
  let arr = applyFiltersSync();
  const needDistance = filters.distance < 2000;
  const canFilterByDistance = needDistance && userPos && USE_PLACES;
  if(canFilterByDistance){
    await Promise.all(arr.map(r=>fetchGeometry(r)));
    arr = arr.filter(r=>{
      const g = geoCache[r.id];
      if(!g) return true;
      const d = haversine(userPos.lat, userPos.lng, g.lat, g.lng);
      return d <= filters.distance;
    });
  }
  pool = arr; index=0; renderStack();
}

// ====== INIT ======
document.addEventListener("DOMContentLoaded", async ()=>{
  renderText();
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos => { userPos = {lat:pos.coords.latitude, lng:pos.coords.longitude}; refreshPool(); }, ()=> refreshPool());
  }else{
    refreshPool();
  }
});
</script>
</body>
</html>
"""
open("/mnt/data/mealr_v16_full.html","w",encoding="utf-8").write(html)
"/mnt/data/mealr_v16_full.html"
